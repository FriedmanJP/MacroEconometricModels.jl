<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Forecast Error Variance Decomposition</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #fff;
    color: #333;
    padding: 20px;
}
.figure-title {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 16px;
    color: #222;
}
.figure-source {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 8px;
}
.panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
}
.panel {
    width: calc(33% - 16px);
    min-width: 300px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 12px;
}
.panel-title {
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 8px;
    color: #444;
}
.axis text { font-size: 11px; fill: #666; }
.axis line, .axis path { stroke: #ccc; }
.grid line { stroke: #f0f0f0; stroke-dasharray: 2,2; }
.grid .domain { stroke: none; }
.tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
}
.legend { font-size: 11px; }
.legend rect { rx: 2; }
svg { overflow: visible; }
</style>
</head>
<body>
<div class="figure-title">Forecast Error Variance Decomposition</div>
<div class="panel-grid">
<div class="panel">
<div class="panel-title">y</div>
<div id="fevd_117"></div>
</div>
<div class="panel">
<div class="panel-title">π</div>
<div id="fevd_118"></div>
</div>
<div class="panel">
<div class="panel-title">R</div>
<div id="fevd_119"></div>
</div>
<div class="panel">
<div class="panel-title">d</div>
<div id="fevd_120"></div>
</div>
<div class="panel">
<div class="panel-title">s</div>
<div id="fevd_121"></div>
</div>
</div>

<div class="tooltip" id="tooltip"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
// Shared utilities
const tooltip = d3.select('#tooltip');
function fmt(v) {
    if (v === null || v === undefined) return '';
    return Math.abs(v) >= 1000 ? v.toFixed(1) : (Math.abs(v) >= 1 ? v.toFixed(3) : v.toFixed(4));
}
function showTip(evt, html) {
    tooltip.html(html).style('opacity',1)
        .style('left',(evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px');
}
function hideTip() { tooltip.style('opacity',0); }

(function() {
    const data = [{"x":1,"s1":0.3076923076923077,"s2":0.6923076923076923},
{"x":2,"s1":0.32849273910866306,"s2":0.671507260891337},
{"x":3,"s1":0.34491550024611584,"s2":0.6550844997538842},
{"x":4,"s1":0.3573473404682674,"s2":0.6426526595317326},
{"x":5,"s1":0.36643135135351745,"s2":0.6335686486464824},
{"x":6,"s1":0.37288022769223356,"s2":0.6271197723077665},
{"x":7,"s1":0.37735383096032954,"s2":0.6226461690396704},
{"x":8,"s1":0.3804011433074878,"s2":0.6195988566925122},
{"x":9,"s1":0.38244756659716633,"s2":0.6175524334028337},
{"x":10,"s1":0.3838067473161081,"s2":0.616193252683892},
{"x":11,"s1":0.38470180505518525,"s2":0.6152981949448147},
{"x":12,"s1":0.3852873568364445,"s2":0.6147126431635556},
{"x":13,"s1":0.38566849024845773,"s2":0.6143315097515423},
{"x":14,"s1":0.38591560203593395,"s2":0.6140843979640661},
{"x":15,"s1":0.3860753390507232,"s2":0.6139246609492769},
{"x":16,"s1":0.38617835734753564,"s2":0.6138216426524644},
{"x":17,"s1":0.3862446784270643,"s2":0.6137553215729357},
{"x":18,"s1":0.38628731630267527,"s2":0.6137126836973247},
{"x":19,"s1":0.386314699458885,"s2":0.613685300541115},
{"x":20,"s1":0.3863322714510118,"s2":0.6136677285489883},
{"x":21,"s1":0.38634354055166514,"s2":0.6136564594483349},
{"x":22,"s1":0.3863507641024634,"s2":0.6136492358975366},
{"x":23,"s1":0.3863553927427822,"s2":0.6136446072572178},
{"x":24,"s1":0.38635835780811917,"s2":0.6136416421918809},
{"x":25,"s1":0.38636025679333336,"s2":0.6136397432066666},
{"x":26,"s1":0.3863614728033578,"s2":0.6136385271966422},
{"x":27,"s1":0.38636225137342217,"s2":0.6136377486265778},
{"x":28,"s1":0.3863627498170559,"s2":0.6136372501829441},
{"x":29,"s1":0.3863630688988735,"s2":0.6136369311011265},
{"x":30,"s1":0.3863632731494382,"s2":0.6136367268505617},
{"x":31,"s1":0.3863634038885324,"s2":0.6136365961114677},
{"x":32,"s1":0.38636348757073746,"s2":0.6136365124292625},
{"x":33,"s1":0.38636354113185156,"s2":0.6136364588681483},
{"x":34,"s1":0.386363575413172,"s2":0.613636424586828},
{"x":35,"s1":0.3863635973542991,"s2":0.6136364026457009},
{"x":36,"s1":0.3863636113971508,"s2":0.6136363886028492},
{"x":37,"s1":0.3863636203848358,"s2":0.6136363796151642},
{"x":38,"s1":0.38636362613708164,"s2":0.6136363738629184},
{"x":39,"s1":0.38636362981858136,"s2":0.6136363701814186},
{"x":40,"s1":0.3863636321747719,"s2":0.6136363678252282}];
    const series = [{"name":"ε_d","color":"#1f77b4","key":"s1","dash":""},{"name":"ε_s","color":"#ff7f0e","key":"s2","dash":""}];

    const container = d3.select('#fevd_117');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":0.03846153846153846,"s2":0.9615384615384615},
{"x":2,"s1":0.04217022370789406,"s2":0.957829776292106},
{"x":3,"s1":0.045242935757944996,"s2":0.954757064242055},
{"x":4,"s1":0.04765945052505316,"s2":0.9523405494749467},
{"x":5,"s1":0.04947707866709314,"s2":0.9505229213329068},
{"x":6,"s1":0.05079504700167845,"s2":0.9492049529983215},
{"x":7,"s1":0.051723165223847394,"s2":0.9482768347761527},
{"x":8,"s1":0.05236199501955747,"s2":0.9476380049804425},
{"x":9,"s1":0.05279405139769078,"s2":0.9472059486023091},
{"x":10,"s1":0.053082378557576866,"s2":0.9469176214424231},
{"x":11,"s1":0.05327284918515018,"s2":0.9467271508148497},
{"x":12,"s1":0.05339771467065127,"s2":0.9466022853293488},
{"x":13,"s1":0.05347909929294416,"s2":0.9465209007070557},
{"x":14,"s1":0.05353191234919464,"s2":0.9464680876508055},
{"x":15,"s1":0.05356607103921949,"s2":0.9464339289607806},
{"x":16,"s1":0.05358810893313154,"s2":0.9464118910668684},
{"x":17,"s1":0.0536022998512086,"s2":0.9463977001487914},
{"x":18,"s1":0.05361142459887001,"s2":0.9463885754011299},
{"x":19,"s1":0.05361728532573515,"s2":0.9463827146742648},
{"x":20,"s1":0.05362104643868815,"s2":0.946378953561312},
{"x":21,"s1":0.053623458577030596,"s2":0.9463765414229693},
{"x":22,"s1":0.053625004810096695,"s2":0.9463749951899032},
{"x":23,"s1":0.05362599560755322,"s2":0.9463740043924469},
{"x":24,"s1":0.053626630310252124,"s2":0.9463733696897477},
{"x":25,"s1":0.05362703681032262,"s2":0.9463729631896775},
{"x":26,"s1":0.05362729711267666,"s2":0.9463727028873232},
{"x":27,"s1":0.0536274637759309,"s2":0.946372536224069},
{"x":28,"s1":0.05362757047459649,"s2":0.9463724295254036},
{"x":29,"s1":0.0536276387784947,"s2":0.9463723612215054},
{"x":30,"s1":0.0536276825011992,"s2":0.9463723174988008},
{"x":31,"s1":0.053627710487753256,"s2":0.9463722895122467},
{"x":32,"s1":0.053627728401119366,"s2":0.9463722715988806},
{"x":33,"s1":0.053627739866639795,"s2":0.9463722601333601},
{"x":34,"s1":0.05362774720504631,"s2":0.9463722527949538},
{"x":35,"s1":0.053627751901858464,"s2":0.9463722480981416},
{"x":36,"s1":0.05362775490793192,"s2":0.946372245092068},
{"x":37,"s1":0.05362775683187463,"s2":0.9463722431681253},
{"x":38,"s1":0.05362775806322527,"s2":0.9463722419367746},
{"x":39,"s1":0.05362775885130305,"s2":0.9463722411486969},
{"x":40,"s1":0.05362775935567939,"s2":0.9463722406443206}];
    const series = [{"name":"ε_d","color":"#1f77b4","key":"s1","dash":""},{"name":"ε_s","color":"#ff7f0e","key":"s2","dash":""}];

    const container = d3.select('#fevd_118');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":0.2862807295796986,"s2":0.7137192704203014},
{"x":2,"s1":0.3062740553739188,"s2":0.6937259446260812},
{"x":3,"s1":0.3221188582163588,"s2":0.6778811417836412},
{"x":4,"s1":0.3341481527594305,"s2":0.6658518472405694},
{"x":5,"s1":0.3429571439434238,"s2":0.6570428560565762},
{"x":6,"s1":0.34922060781866965,"s2":0.6507793921813303},
{"x":7,"s1":0.3535703938483999,"s2":0.6464296061516002},
{"x":8,"s1":0.35653562123489874,"s2":0.6434643787651013},
{"x":9,"s1":0.3585279476133169,"s2":0.641472052386683},
{"x":10,"s1":0.3598516550435492,"s2":0.6401483449564509},
{"x":11,"s1":0.36072355170533305,"s2":0.639276448294667},
{"x":12,"s1":0.3612940369367744,"s2":0.6387059630632256},
{"x":13,"s1":0.3616653999548633,"s2":0.6383346000451366},
{"x":14,"s1":0.36190619233161336,"s2":0.6380938076683865},
{"x":15,"s1":0.36206185079403475,"s2":0.6379381492059651},
{"x":16,"s1":0.3621622414053756,"s2":0.6378377585946244},
{"x":17,"s1":0.3622268719433883,"s2":0.6377731280566116},
{"x":18,"s1":0.36226842342718585,"s2":0.6377315765728141},
{"x":19,"s1":0.36229510906354084,"s2":0.6377048909364592},
{"x":20,"s1":0.362312233529549,"s2":0.6376877664704509},
{"x":21,"s1":0.36232321565915526,"s2":0.6376767843408447},
{"x":22,"s1":0.36233025527324314,"s2":0.6376697447267567},
{"x":23,"s1":0.36233476605770826,"s2":0.6376652339422918},
{"x":24,"s1":0.36233765562786896,"s2":0.6376623443721311},
{"x":25,"s1":0.3623395062628775,"s2":0.6376604937371226},
{"x":26,"s1":0.36234069131235286,"s2":0.6376593086876471},
{"x":27,"s1":0.3623414500595789,"s2":0.6376585499404211},
{"x":28,"s1":0.3623419358126159,"s2":0.637658064187384},
{"x":29,"s1":0.3623422467704943,"s2":0.6376577532295057},
{"x":30,"s1":0.36234244582077585,"s2":0.6376575541792241},
{"x":31,"s1":0.36234257323121616,"s2":0.6376574267687839},
{"x":32,"s1":0.36234265478285066,"s2":0.6376573452171495},
{"x":33,"s1":0.3623427069802857,"s2":0.6376572930197143},
{"x":34,"s1":0.36234274038879566,"s2":0.6376572596112043},
{"x":35,"s1":0.3623427617712966,"s2":0.6376572382287035},
{"x":36,"s1":0.3623427754566141,"s2":0.6376572245433859},
{"x":37,"s1":0.36234278421547067,"s2":0.6376572157845294},
{"x":38,"s1":0.36234278982126306,"s2":0.637657210178737},
{"x":39,"s1":0.36234279340903097,"s2":0.637657206590969},
{"x":40,"s1":0.3623427957052323,"s2":0.6376572042947678}];
    const series = [{"name":"ε_d","color":"#1f77b4","key":"s1","dash":""},{"name":"ε_s","color":"#ff7f0e","key":"s2","dash":""}];

    const container = d3.select('#fevd_119');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":1.0,"s2":0.0},
{"x":2,"s1":1.0,"s2":0.0},
{"x":3,"s1":1.0,"s2":0.0},
{"x":4,"s1":1.0,"s2":0.0},
{"x":5,"s1":1.0,"s2":0.0},
{"x":6,"s1":1.0,"s2":0.0},
{"x":7,"s1":1.0,"s2":0.0},
{"x":8,"s1":1.0,"s2":0.0},
{"x":9,"s1":1.0,"s2":0.0},
{"x":10,"s1":1.0,"s2":0.0},
{"x":11,"s1":1.0,"s2":0.0},
{"x":12,"s1":1.0,"s2":0.0},
{"x":13,"s1":1.0,"s2":0.0},
{"x":14,"s1":1.0,"s2":0.0},
{"x":15,"s1":1.0,"s2":0.0},
{"x":16,"s1":1.0,"s2":0.0},
{"x":17,"s1":1.0,"s2":0.0},
{"x":18,"s1":1.0,"s2":0.0},
{"x":19,"s1":1.0,"s2":0.0},
{"x":20,"s1":1.0,"s2":0.0},
{"x":21,"s1":1.0,"s2":0.0},
{"x":22,"s1":1.0,"s2":0.0},
{"x":23,"s1":1.0,"s2":0.0},
{"x":24,"s1":1.0,"s2":0.0},
{"x":25,"s1":1.0,"s2":0.0},
{"x":26,"s1":1.0,"s2":0.0},
{"x":27,"s1":1.0,"s2":0.0},
{"x":28,"s1":1.0,"s2":0.0},
{"x":29,"s1":1.0,"s2":0.0},
{"x":30,"s1":1.0,"s2":0.0},
{"x":31,"s1":1.0,"s2":0.0},
{"x":32,"s1":1.0,"s2":0.0},
{"x":33,"s1":1.0,"s2":0.0},
{"x":34,"s1":1.0,"s2":0.0},
{"x":35,"s1":1.0,"s2":0.0},
{"x":36,"s1":1.0,"s2":0.0},
{"x":37,"s1":1.0,"s2":0.0},
{"x":38,"s1":1.0,"s2":0.0},
{"x":39,"s1":1.0,"s2":0.0},
{"x":40,"s1":1.0,"s2":0.0}];
    const series = [{"name":"ε_d","color":"#1f77b4","key":"s1","dash":""},{"name":"ε_s","color":"#ff7f0e","key":"s2","dash":""}];

    const container = d3.select('#fevd_120');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

(function() {
    const data = [{"x":1,"s1":0.0,"s2":1.0},
{"x":2,"s1":0.0,"s2":1.0},
{"x":3,"s1":0.0,"s2":1.0},
{"x":4,"s1":0.0,"s2":1.0},
{"x":5,"s1":0.0,"s2":1.0},
{"x":6,"s1":0.0,"s2":1.0},
{"x":7,"s1":0.0,"s2":1.0},
{"x":8,"s1":0.0,"s2":1.0},
{"x":9,"s1":0.0,"s2":1.0},
{"x":10,"s1":0.0,"s2":1.0},
{"x":11,"s1":0.0,"s2":1.0},
{"x":12,"s1":0.0,"s2":1.0},
{"x":13,"s1":0.0,"s2":1.0},
{"x":14,"s1":0.0,"s2":1.0},
{"x":15,"s1":0.0,"s2":1.0},
{"x":16,"s1":0.0,"s2":1.0},
{"x":17,"s1":0.0,"s2":1.0},
{"x":18,"s1":0.0,"s2":1.0},
{"x":19,"s1":0.0,"s2":1.0},
{"x":20,"s1":0.0,"s2":1.0},
{"x":21,"s1":0.0,"s2":1.0},
{"x":22,"s1":0.0,"s2":1.0},
{"x":23,"s1":0.0,"s2":1.0},
{"x":24,"s1":0.0,"s2":1.0},
{"x":25,"s1":0.0,"s2":1.0},
{"x":26,"s1":0.0,"s2":1.0},
{"x":27,"s1":0.0,"s2":1.0},
{"x":28,"s1":0.0,"s2":1.0},
{"x":29,"s1":0.0,"s2":1.0},
{"x":30,"s1":0.0,"s2":1.0},
{"x":31,"s1":0.0,"s2":1.0},
{"x":32,"s1":0.0,"s2":1.0},
{"x":33,"s1":0.0,"s2":1.0},
{"x":34,"s1":0.0,"s2":1.0},
{"x":35,"s1":0.0,"s2":1.0},
{"x":36,"s1":0.0,"s2":1.0},
{"x":37,"s1":0.0,"s2":1.0},
{"x":38,"s1":0.0,"s2":1.0},
{"x":39,"s1":0.0,"s2":1.0},
{"x":40,"s1":0.0,"s2":1.0}];
    const series = [{"name":"ε_d","color":"#1f77b4","key":"s1","dash":""},{"name":"ε_s","color":"#ff7f0e","key":"s2","dash":""}];

    const container = d3.select('#fevd_121');
    const W = Math.max(container.node().clientWidth - 24, 280);
    const margin = {top:10, right:15, bottom:35, left:55};
    const w = W - margin.left - margin.right;
    const h = Math.min(w * 0.6, 250);

    const svg = container.append('svg').attr('width', W).attr('height', h + margin.top + margin.bottom);
    const g = svg.append('g').attr('transform', 'translate('+margin.left+','+margin.top+')');

    const keys = series.map(s => s.key);
    const x = d3.scaleLinear().domain(d3.extent(data, d=>d.x)).range([0,w]);
    const y = d3.scaleLinear().domain([0,1]).range([h,0]);

    const stack = d3.stack().keys(keys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    const stacked = stack(data);

    const area = d3.area()
        .x(d => x(d.data.x))
        .y0(d => y(d[0]))
        .y1(d => y(d[1]));

    g.selectAll('.layer').data(stacked).join('path')
        .attr('class','layer')
        .attr('d', area)
        .attr('fill', (d,i) => series[i].color)
        .attr('opacity', 0.85);

    g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-w).tickFormat(''));
    g.append('g').attr('class','axis').attr('transform','translate(0,'+h+')')
        .call(d3.axisBottom(x).ticks(Math.min(data.length,8)));
    g.append('g').attr('class','axis').call(d3.axisLeft(y).ticks(5).tickFormat(d3.format('.0%')));

    if('Horizon') g.append('text').attr('x',w/2).attr('y',h+30).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Horizon');
    if('Proportion') g.append('text').attr('transform','rotate(-90)')
        .attr('x',-h/2).attr('y',-42).attr('text-anchor','middle')
        .attr('font-size','11px').attr('fill','#666').text('Proportion');

    // Legend
    const leg = g.append('g').attr('class','legend').attr('transform','translate(5,-5)');
    series.forEach((s,i) => {
        const gi = leg.append('g').attr('transform','translate('+(i*90)+',0)');
        gi.append('rect').attr('width',12).attr('height',12).attr('y',-6).attr('fill',s.color).attr('opacity',0.85);
        gi.append('text').attr('x',16).attr('y',4).attr('font-size','10px').attr('fill','#555').text(s.name);
    });

    // Tooltip
    svg.append('rect').attr('width',W).attr('height',h+margin.top+margin.bottom)
        .attr('fill','none').attr('pointer-events','all')
        .on('mousemove', function(evt) {
            const [mx] = d3.pointer(evt, g.node());
            const x0 = x.invert(mx);
            const idx = d3.minIndex(data, d => Math.abs(d.x - x0));
            const d = data[idx];
            let html = '<b>h='+d.x+'</b>';
            series.forEach(s => { html += '<br>'+s.name+': '+(d[s.key]*100).toFixed(1)+'%'; });
            showTip(evt, html);
        })
        .on('mouseout', hideTip);
})();

</script>
</body>
</html>